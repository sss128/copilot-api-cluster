# Portainer 部署配置 - 支持环境变量
# 使用命名卷进行数据持久化，所有关键配置均可通过环境变量自定义
# 新增节点：复制任意 copilot-node-X 块，修改数字即可

version: '3.8'

# ===== 共享配置模板 =====
x-copilot-node: &copilot-node-template
  build:
    context: .
    dockerfile: Dockerfile.copilot-api-src
    args:
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
  restart: unless-stopped
  environment:
    - HOST=0.0.0.0
  networks:
    - copilot-net
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:4141/"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s

services:
  # ===== Copilot 节点（新增节点只需复制下面3行并改数字）=====
  copilot-node-1:
    <<: *copilot-node-template
    container_name: copilot-node-1
    volumes: [copilot_data_node1:/root/.local/share/copilot-api]

  copilot-node-2:
    <<: *copilot-node-template
    container_name: copilot-node-2
    volumes: [copilot_data_node2:/root/.local/share/copilot-api]

  copilot-node-3:
    <<: *copilot-node-template
    container_name: copilot-node-3
    volumes: [copilot_data_node3:/root/.local/share/copilot-api]

  copilot-node-4:
    <<: *copilot-node-template
    container_name: copilot-node-4
    volumes: [copilot_data_node4:/root/.local/share/copilot-api]

  copilot-node-5:
    <<: *copilot-node-template
    container_name: copilot-node-5
    volumes: [copilot_data_node5:/root/.local/share/copilot-api]

  # ===== 智能网关 =====
  smart-gateway:
    build: ./gateway
    container_name: smart-gateway
    restart: always
    ports:
      - "${GATEWAY_PORT:-8080}:3000"
    environment:
      PORT: ${GATEWAY_CONTAINER_PORT:-3000}
      # 简化配置：只需设置节点数量，网关自动生成节点URL
      NODE_COUNT: 5
      POLL_INTERVAL: ${POLL_INTERVAL:-300000}
      RETRY_LIMIT: ${RETRY_LIMIT:-3}
    depends_on:
      copilot-node-1:
        condition: service_healthy
      copilot-node-2:
        condition: service_healthy
      copilot-node-3:
        condition: service_healthy
      copilot-node-4:
        condition: service_healthy
      copilot-node-5:
        condition: service_healthy
    networks:
      - copilot-net

# 命名卷（新增节点需在此添加对应卷）
volumes:
  copilot_data_node1:
  copilot_data_node2:
  copilot_data_node3:
  copilot_data_node4:
  copilot_data_node5:

networks:
  copilot-net: