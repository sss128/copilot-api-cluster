# Portainer 部署配置
# 新增节点：复制 node-X 块，改数字，并在 volumes 区域添加对应卷
# 节点会通过 copilot.node=true label 被网关自动发现

version: '3.8'

# ===== 共享配置模板 =====
x-copilot-node: &copilot-node-template
  build:
    context: .
    dockerfile: Dockerfile.copilot-api-src
    args:
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
  image: copilot-api-node:v0.7.0
  restart: unless-stopped
  environment:
    - HOST=0.0.0.0
    - NODE_VERSION=v0.7.0
  networks:
    - copilot-net
  labels:
    - "copilot.node=true"
  healthcheck:
    # 检查服务可用且配额未耗尽 (remaining > 0)
    test: ["CMD-SHELL", "curl -sf http://localhost:4141/usage | grep -q '\"remaining\":[1-9]'"]
    interval: 5m
    timeout: 10s
    retries: 3
    start_period: 30s

services:
  # ===== Copilot 节点 =====
  # 新增节点：复制一行，改数字即可（volumes 会自动创建）
  node-1: { <<: *copilot-node-template, container_name: copilot-node-1, ports: ["4141:4141"], volumes: ["copilot-data-1:/root/.local/share/copilot-api"] }
  node-2: { <<: *copilot-node-template, container_name: copilot-node-2, ports: ["4142:4141"], volumes: ["copilot-data-2:/root/.local/share/copilot-api"] }
  node-3: { <<: *copilot-node-template, container_name: copilot-node-3, ports: ["4143:4141"], volumes: ["copilot-data-3:/root/.local/share/copilot-api"] }
  node-4: { <<: *copilot-node-template, container_name: copilot-node-4, ports: ["4144:4141"], volumes: ["copilot-data-4:/root/.local/share/copilot-api"] }

  # ===== 智能网关 =====
  # 网关通过 Docker API 自动发现带 copilot.node=true label 的容器
  smart-gateway:
    build: ./gateway
    image: copilot-api-cluster-gateway:v1.1.1
    restart: always
    ports: ["${GATEWAY_PORT:-8080}:3000"]
    environment:
      PORT: 3000
      POLL_INTERVAL: ${POLL_INTERVAL:-300000}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - copilot-net

networks:
  copilot-net:

# 命名卷（新增节点需在此添加对应卷）
volumes:
  copilot-data-1:
  copilot-data-2:
  copilot-data-3:
  copilot-data-4:
