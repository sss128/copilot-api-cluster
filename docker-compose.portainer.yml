# Portainer 部署配置
# 新增节点：复制 node-X 块，改数字，并在 volumes 区域添加对应卷
# 节点会通过 copilot.node=true label 被网关自动发现

version: '3.8'

# ===== 共享配置模板 =====
x-copilot-node: &copilot-node-template
  build:
    context: .
    dockerfile: Dockerfile.copilot-api-src
    args:
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
  restart: unless-stopped
  environment:
    - HOST=0.0.0.0
    - NODE_VERSION=v0.7.0
  networks:
    - copilot-net
  labels:
    - "copilot.node=true"
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:4141/"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s

services:
  # ===== Copilot 节点 =====
  # 新增节点：复制下面的模板，把 N 替换成新数字
  node-2: { <<: *copilot-node-template, ports: ["4142:4141"], volumes: ["data-2:/root/.local/share/copilot-api"] }
  node-3: { <<: *copilot-node-template, ports: ["4143:4141"], volumes: ["data-3:/root/.local/share/copilot-api"] }

  # ===== 智能网关 =====
  # 网关通过 Docker API 自动发现带 copilot.node=true label 的容器
  smart-gateway:
    build: ./gateway
    restart: always
    ports: ["${GATEWAY_PORT:-8080}:3000"]
    environment:
      PORT: 3000
      POLL_INTERVAL: ${POLL_INTERVAL:-300000}
      GATEWAY_VERSION=1.0.0  # 每次修改 gateway.js 后，手动改一下这个数字
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - copilot-net

networks:
  copilot-net:

# 命名卷（新增节点需在此添加对应卷）
volumes:
  data-2:
  data-3:
