# Portainer 部署配置
# 新增节点：复制 copilot-node-X 块，改数字，并在 volumes 区域添加对应卷

version: '3.8'

# ===== 共享配置模板 =====
x-copilot-node: &copilot-node-template
  build:
    context: .
    dockerfile: Dockerfile.copilot-api-src
    args:
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
  restart: unless-stopped
  environment:
    - HOST=0.0.0.0
  networks:
    - copilot-net
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:4141/"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s

services:
  # ===== Copilot 节点 =====
  # 新增节点：复制下面的模板，把 N 替换成新数字
  node-2: { <<: *copilot-node-template, ports: ["4142:4141"], volumes: ["data-2:/root/.local/share/copilot-api"] }
  node-3: { <<: *copilot-node-template, ports: ["4143:4141"], volumes: ["data-3:/root/.local/share/copilot-api"] }

  # ===== 智能网关 =====
  # 网关启动时自动探测 copilot-node-1, copilot-node-2... 无需配置节点数量
  smart-gateway:
    build: ./gateway
    restart: always
    ports: ["${GATEWAY_PORT:-8080}:3000"]
    environment:
      PORT: 3000
      POLL_INTERVAL: ${POLL_INTERVAL:-300000}
    networks:
      - copilot-net

networks:
  copilot-net:

# 命名卷（新增节点需在此添加对应卷）
volumes:
  data-2:
  data-3:
